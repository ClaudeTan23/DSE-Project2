{% extends "layouts/base.html" %}

{% block title %} Products {% endblock %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}


  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center py-4">
      <div class="d-block mb-4 mb-md-0">
          <h2 class="h4">Products</h2>
      </div>
      <div class="btn-toolbar mb-2 mb-md-0" data-bs-toggle="modal" data-bs-target="#addProductModal">
          <div href="#" class="btn btn-sm btn-gray-800 d-inline-flex align-items-center">
              <svg class="icon icon-xs me-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
              Add Product
          </div>
      </div>
  </div>

    <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content shadow-lg rounded-4">

                <!-- Modal Header -->
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="addProductModalLabel">Add New Product</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal Body -->
                <div class="modal-body">
                    <form id="addProductForm">

                        <div class="row g-3">

                            <div class="col-md-6">
                                <label class="form-label">Product Name</label>
                                <input type="text" class="form-control" name="name" required>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">SKU</label>
                                <input type="text" class="form-control" name="sku" required>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Category</label>
                                <input class="form-control" name="category" required>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Unit Price (RM)</label>
                                <input type="number" step="0.01" class="form-control" name="price" required>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Initial Stock</label>
                                <input type="number" class="form-control" name="stock" required>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Status</label>
                                <select class="form-select" name="status">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>

                            <div class="col-12">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" rows="3" name="description"></textarea>
                            </div>

                        </div>

                    </form>
                </div>

                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="submit" form="addProductForm" class="btn btn-success">
                        Save Product
                    </button>
                </div>

            </div>
        </div>
    </div>
  
  <div class="table-settings mb-4">
      <div class="row align-items-center justify-content-between">
          <div class="col col-md-6 col-lg-3 col-xl-4">
              <div class="input-group me-2 me-lg-3 fmxw-400">
                  <span class="input-group-text">
                      <svg class="icon icon-xs" x-description="Heroicon name: solid/search" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                          <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                      </svg>
                  </span>
                  <input type="text" class="form-control" placeholder="Search Products">
              </div>
          </div>
      </div>
  </div>

<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Product</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="editProductId">

                <div class="mb-2">
                    <label>Name</label>
                    <input class="form-control" id="editName" required>
                </div>

                <div class="mb-2">
                    <label>SKU</label>
                    <input class="form-control" id="editSku" required>
                </div>

                <div class="mb-2">
                    <label>Category</label>
                    <input class="form-control" id="editCategory" required>
                </div>

                <div class="mb-2">
                    <label>Stock</label>
                    <input type="number" class="form-control" id="editStock" required>
                </div>

                <div class="mb-2">
                    <label>Price</label>
                    <input type="number" step="0.01" class="form-control" id="editPrice" required>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" onclick="saveProduct()">Save</button>
            </div>
        </div>
    </div>
</div>
  
  <div class="card card-body border-0 shadow table-wrapper table-responsive">
      <table class="table table-hover">
          <thead>
              <tr>
                  <th class="border-gray-200">#ID</th>
                  <th class="border-gray-200">Name</th>						
                  <th class="border-gray-200">SKU</th>
                  <th class="border-gray-200">Category</th>
                  <th class="border-gray-200">Price</th>
                  <th class="border-gray-200">Stock</th>
                  <th class="border-gray-200">Status</th>
                <th class="border-gray-200">Action</th>
              </tr>
          </thead>
        <tbody>
            {% for p in products %}
            <tr>
                <td>
                    <a href="#" class="fw-bold">
                        {{ p.id }}
                    </a>
                </td>
                <td>
                    <span class="fw-normal">{{ p.name }}</span>
                </td>
                <td><span class="fw-normal">{{ p.sku }}</span></td>
                <td><span class="fw-normal">{{ p.category }}</span></td>
                <td><span class="fw-bold">RM {{ p.price }}</span></td>
                <td><span class="fw-bold text-success">{{ p.stock }}</span></td>
                <td>
                    <span class="fw-bold">{{ p.status }}</span>
                </td>
                <td>
                    <div class="btn-group">
                        <button class="btn btn-link text-dark dropdown-toggle dropdown-toggle-split m-0 p-0" data-bs-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            <span class="icon icon-sm">
                                <span class="fas fa-ellipsis-h icon-dark"></span>
                            </span>
                            <span class="fw-bold cursor-pointer">Toggle Dropdown</span>
                        </button>
                        <div class="dropdown-menu py-0" style="cursor: pointer;">
                            <!-- Edit -->
                            <div class="dropdown-item" onclick="openEditModal(this)" data-id="{{ p.id }}" data-name="{{ p.name }}"
                                data-sku="{{ p.sku }}" data-category="{{ p.category }}" data-price="{{ p.price }}"
                                data-stock="{{ p.stock }}">
                                <span class="fas fa-edit me-2"></span> Edit
                            </div>
                            
                            <!-- Delete -->
                            <div class="dropdown-item text-danger rounded-bottom" onclick="deleteProduct(this)" data-id="{{ p.id }}">
                                <span class="fas fa-trash-alt me-2"></span> Remove
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
            
            {% empty %}
            <tr>
                <td colspan="6" class="text-center text-muted">
                    No products found
                </td>
            </tr>
            {% endfor %}
        </tbody>
      </table>
    <div class="card-footer px-3 border-0 d-flex flex-column flex-lg-row align-items-center justify-content-between">
    
        <nav aria-label="Page navigation">
            <ul class="pagination mb-0">
    
                <!-- Previous -->
                <li class="page-item {% if not product.has_previous %}disabled{% endif %}">
                    {% if product.has_previous %}
                    <a class="page-link" href="?page={{ product.previous_page_number }}">
                        Previous
                    </a>
                    {% else %}
                    <span class="page-link">Previous</span>
                    {% endif %}
                </li>
    
                <!-- Page Numbers -->
                {% for num in paginator.page_range %}
                {% if num == product.number %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
                {% elif num >= product.number|add:"-2" and num <= product.number|add:"2" %} <li class="page-item">
                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                    </li>
                    {% endif %}
                    {% endfor %}
    
                    <!-- Next -->
                    <li class="page-item {% if not product.has_next %}disabled{% endif %}">
                        {% if product.has_next %}
                        <a class="page-link" href="?page={{ product.next_page_number }}">
                            Next
                        </a>
                        {% else %}
                        <span class="page-link">Next</span>
                        {% endif %}
                    </li>
    
            </ul>
        </nav>
    
        <div class="fw-normal small mt-4 mt-lg-0">
            Showing
            <b>{{ product.start_index }}</b>
            â€“
            <b>{{ product.end_index }}</b>
            out of
            <b>{{ paginator.count }}</b>
            entries
        </div>
    
    </div>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<script>

    document.getElementById('addProductForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            fetch('/products/add/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            })
                .then(res => res.json())
                .then(res => {
                    if (res.success) {
                        alert('Product added successfully');
                        location.reload(); // or update table dynamically
                    } else {
                        alert('Failed' + res.error);
                    }
                });
        });

        function openEditModal(el) {
            document.getElementById("editProductId").value = el.dataset.id;
            document.getElementById("editName").value = el.dataset.name;
            document.getElementById("editSku").value = el.dataset.sku;
            document.getElementById("editCategory").value = el.dataset.category;
            document.getElementById("editStock").value = el.dataset.stock;
            document.getElementById("editPrice").value = el.dataset.price;

            new bootstrap.Modal(document.getElementById("editProductModal")).show();
        }

        function saveProduct() {
            const id = document.getElementById("editProductId").value;

            fetch(`/products/update/${id}/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                    name: document.getElementById("editName").value,
                    sku: document.getElementById("editSku").value,
                    category: document.getElementById("editCategory").value,
                    price: document.getElementById("editPrice").value,
                    stock: document.getElementById("editStock").value
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) location.reload();
            });
        }

        function deleteProduct(el) {
            if (!confirm("Are you sure?")) return;
            console.log(el)
            const id = el.dataset.id;

            fetch(`/products/delete/${id}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}"
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) location.reload();
            });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie) {
                document.cookie.split(';').forEach(cookie => {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    }
                });
            }
            return cookieValue;
        }
</script>
{% endblock javascripts %}
