{% extends "layouts/base.html" %}

{% block title %} Stock {% endblock %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}


  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center py-4">
      <div class="d-block mb-4 mb-md-0">
          <h2 class="h4">Sale Transaction</h2>
      </div>
      
  </div>
  
<div class="row justify-content-center mt-4">
    <div class="container mt-5 pos-wrapper">
    
        <div class="card shadow border-0">
            <div class="card-header">
                <h4 class="mb-0">New Sale</h4>
            </div>
    
            <div class="card-body">
    
                <!-- Sale Table -->
                <table class="table table-bordered" id="saleTable">
                    <thead class="table-light">
                        <tr>
                            <th>Product</th>
                            <th width="120">Qty</th>
                            <th width="120">Unit Price</th>
                            <th width="120">Total</th>
                            <th width="50"></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
    
                <button class="btn btn-sm btn-primary" onclick="addRow()">Add Item</button>
    
                <hr>
    
                <div class="d-flex justify-content-between align-items-center">
                    <h4>Grand Total</h4>
                    <h4>RM <span id="grandTotal">0.00</span></h4>
                </div>
    
                <div class="mt-3">
                    <button class="btn btn-success w-100" onclick="submitSale()">
                        Save Sale
                    </button>
                </div>
    
            </div>
        </div>
    
    </div>
    
    <!-- Row Template -->
    <template id="rowTemplate">
        <tr>
            <td>
                <select class="form-select product" onchange="updateRow(this)">
                    <option value="">-- Select Product --</option>
                    {% for p in products %}
                    <option value="{{ p.id }}" data-price="{{ p.price }}">
                        {{ p.name }}
                    </option>
                    {% endfor %}
                </select>
            </td>
    
            <td>
                <input type="number" class="form-control qty" min="1" value="1" onchange="updateRow(this)" required>
            </td>
    
            <td class="unit-price text-end">0.00</td>
            <td class="line-total text-end">0.00</td>
    
            <td class="text-center">
                <button class="btn btn-sm btn-danger" onclick="removeRow(this)">âœ•</button>
            </td>
        </tr>
    </template>
</div>



{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<script>
    function addRow() {
        const tpl = document.getElementById("rowTemplate").content.cloneNode(true);
        document.querySelector("#saleTable tbody").appendChild(tpl);
    }

    function removeRow(btn) {
        btn.closest("tr").remove();
        calculateGrandTotal();
    }

    function updateRow(el) {
        const row = el.closest("tr");

        const productSelect = row.querySelector(".product");
        const qtyInput = row.querySelector(".qty");

        const priceCell = row.querySelector(".unit-price");
        const totalCell = row.querySelector(".line-total");

        const price = productSelect.selectedOptions[0]?.dataset.price || 0;
        const qty = parseInt(qtyInput.value || 0);

        const lineTotal = price * qty;

        priceCell.innerText = parseFloat(price).toFixed(2);
        totalCell.innerText = lineTotal.toFixed(2);

        calculateGrandTotal();
    }

    /* ================================
    TOTAL CALCULATION
    ================================ */

    function calculateGrandTotal() {
        let total = 0;

        document.querySelectorAll(".line-total").forEach(td => {
            total += parseFloat(td.innerText || 0);
        });

        document.getElementById("grandTotal").innerText = total.toFixed(2);
    }

    function submitSale() {
        const items = [];

        document.querySelectorAll("#saleTable tbody tr").forEach(row => {
            const productId = row.querySelector(".product").value;
            const qty = row.querySelector(".qty").value;
            const price = row.querySelector(".unit-price").innerText;
            const total = row.querySelector(".line-total").innerText;

            if (!productId) return;

            items.push({
                product_id: productId,
                quantity: qty,
                unit_price: price,
                line_total: total
            });
        });

        if (items.length === 0) {
            alert("Please add at least one product");
            return;
        }

        fetch("{% url 'create_sale' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                payment_method: "Cash",
                items: items
            })
        })
        .then(res => res.json())
        .then(res => {
            if (res.success) {
                alert("Sale created!\nInvoice: " + res.invoice_no);
                location.reload();
            } else {
                alert(res.error);
            }
        })
        .catch(err => {
            console.error(err);
            alert("Error saving sale");
        });
    }

    /* ================================
    INIT
    ================================ */

    document.addEventListener("DOMContentLoaded", () => {
        addRow();
    });
</script>
{% endblock javascripts %}
